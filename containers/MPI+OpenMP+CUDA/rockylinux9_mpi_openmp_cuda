FROM "nvidia/cuda:12.8.1-devel-rockylinux9" as base
LABEL type=diffrg-image

# set a directory for the app
WORKDIR /

COPY ../deploy.sh /deploy.sh

# enable the devel repo
RUN sed 's/#baseurl/baseurl/g' -i /etc/yum.repos.d/rocky-devel.repo
# install dependencies
RUN dnf --enablerepo=devel install -y gcc-toolset-12 cmake patch git openblas-devel doxygen doxygen-latex python3 python3-pip gsl-devel openmpi-devel libomp-devel
# install DiFfRG
RUN echo "source /opt/rh/gcc-toolset-12/enable" > /.bashenv && \
    echo "source /etc/profile.d/modules.sh" >> /.bashenv && \
    echo "module load mpi" >> /.bashenv
ENV BASH_ENV=/.bashenv
RUN bash deploy.sh
